name: CD Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - production

permissions:
  contents: read
  packages: read

env:
  IMAGE_NAME: ghcr.io/aleyamayab/devsu-demo-devops-python
  KUBE_CONFIG_PATH: ~/.kube/config

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to ${{ github.event.inputs.environment }}
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Get latest version
        id: version
        run: |
          # Obtiene el Ãºltimo tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "version=${LATEST_TAG}" >> $GITHUB_OUTPUT
          echo "Latest version: ${LATEST_TAG}"

      - name: Set deployment configuration
        id: config
        run: |
          ENV="${{ github.event.inputs.environment }}"
          case $ENV in
            dev)
              echo "namespace=dev" >> $GITHUB_OUTPUT
              echo "replicas=2" >> $GITHUB_OUTPUT
              echo "image_tag=v${{ steps.version.outputs.version }}-dev" >> $GITHUB_OUTPUT
              ;;
            qa)
              echo "namespace=qa" >> $GITHUB_OUTPUT
              echo "replicas=3" >> $GITHUB_OUTPUT
              echo "image_tag=v${{ steps.version.outputs.version }}-qa" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "namespace=production" >> $GITHUB_OUTPUT
              echo "replicas=4" >> $GITHUB_OUTPUT
              echo "image_tag=v${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Setup Minikube (for local testing)
        uses: hiberbee/github-action-minikube@minikube-latest
        if: ${{ github.event_name == 'workflow_dispatch' && runner.os == 'Linux' }}
        with:
          driver: docker
          kubernetes-version: latest

      - name: Update deployment manifest
        run: |
          # Actualiza la imagen en el manifest
          sed -i "s|image: ghcr.io/aleyamayab/devsu-demo-devops-python:[^[:space:]]*|image: ${{ env.IMAGE_NAME }}:${{ steps.config.outputs.image_tag }}|g" \
            k8s/base/deployment.yml
          
          # Actualiza replicas
          sed -i "s|replicas: [0-9]*|replicas: ${{ steps.config.outputs.replicas }}|g" \
            k8s/base/deployment.yml
          
          echo "Updated manifest:"
          cat k8s/base/deployment.yml | grep -A 2 "image:"

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/base/ -n ${{ steps.config.outputs.namespace }} \
            --record \
            -o name
          
          echo "Waiting for deployment to be ready..."
          kubectl rollout status deployment/devsu-app \
            -n ${{ steps.config.outputs.namespace }} \
            --timeout=5m

      - name: Verify deployment
        run: |
          echo "Deployment status:"
          kubectl get pods -n ${{ steps.config.outputs.namespace }} -l app=devsu-app
          
          echo ""
          echo "Service info:"
          kubectl get svc -n ${{ steps.config.outputs.namespace }}

      - name: Create deployment summary
        if: always()
        run: |
          echo "### Deployment to ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ steps.config.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** ${{ steps.config.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "**Replicas:** ${{ steps.config.outputs.replicas }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
