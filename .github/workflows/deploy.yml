name: CD Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - qa
          - production
      image_tag:
        description: 'Image tag to promote (from develop build)'
        required: true
        type: string

permissions:
  contents: read
  packages: read

env:
  IMAGE_NAME: ghcr.io/aleyamayab/devsu-demo-devops-python
  KUBE_CONFIG_PATH: ~/.kube/config

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to ${{ github.event.inputs.environment }}
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set deployment configuration
        id: config
        run: |
          ENV="${{ github.event.inputs.environment }}"
          case $ENV in
            dev)
              echo "namespace=dev" >> $GITHUB_OUTPUT
              echo "replicas=2" >> $GITHUB_OUTPUT
              echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
              echo "promotion_gate=none" >> $GITHUB_OUTPUT
              ;;
            qa)
              echo "namespace=qa" >> $GITHUB_OUTPUT
              echo "replicas=3" >> $GITHUB_OUTPUT
              echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
              echo "promotion_gate=dev" >> $GITHUB_OUTPUT
              ;;
            production)
              echo "namespace=production" >> $GITHUB_OUTPUT
              echo "replicas=4" >> $GITHUB_OUTPUT
              echo "image_tag=${{ github.event.inputs.image_tag }}" >> $GITHUB_OUTPUT
              echo "promotion_gate=qa" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Check promotion gate
        if: ${{ steps.config.outputs.promotion_gate != 'none' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REQUIRED_ENV="${{ steps.config.outputs.promotion_gate }}"
          TAG="${{ steps.config.outputs.image_tag }}"
          REQUIRED_ARTIFACT="promoted-${REQUIRED_ENV}-${TAG}"
          export REQUIRED_ARTIFACT

          python - <<'PY'
          import json
          import os
          import sys
          import urllib.request

          repo = os.environ["GITHUB_REPOSITORY"]
          token = os.environ["GITHUB_TOKEN"]
          required = os.environ["REQUIRED_ARTIFACT"]
          url = f"https://api.github.com/repos/{repo}/actions/artifacts?per_page=100"

          req = urllib.request.Request(url)
          req.add_header("Authorization", f"Bearer {token}")
          req.add_header("Accept", "application/vnd.github+json")

          with urllib.request.urlopen(req) as resp:
            data = json.loads(resp.read().decode("utf-8"))

          names = {a["name"] for a in data.get("artifacts", [])}
          if required not in names:
            print(f"Missing promotion artifact: {required}")
            sys.exit(1)
          print(f"Promotion gate passed: {required}")
          PY

      - name: Setup Minikube (for local testing)
        uses: hiberbee/github-action-minikube@minikube-latest
        if: ${{ github.event_name == 'workflow_dispatch' && runner.os == 'Linux' }}
        with:
          driver: docker
          kubernetes-version: latest

      - name: Update deployment manifest
        run: |
          # Actualiza la imagen en el manifest
          sed -i "s|image: ghcr.io/aleyamayab/devsu-demo-devops-python:[^[:space:]]*|image: ${{ env.IMAGE_NAME }}:${{ steps.config.outputs.image_tag }}|g" \
            k8s/base/deployment.yml
          
          # Actualiza replicas
          sed -i "s|replicas: [0-9]*|replicas: ${{ steps.config.outputs.replicas }}|g" \
            k8s/base/deployment.yml
          
          echo "Updated manifest:"
          cat k8s/base/deployment.yml | grep -A 2 "image:"

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/base/ -n ${{ steps.config.outputs.namespace }} \
            --record \
            -o name
          
          echo "Waiting for deployment to be ready..."
          kubectl rollout status deployment/devsu-app \
            -n ${{ steps.config.outputs.namespace }} \
            --timeout=5m

      - name: Verify deployment
        run: |
          echo "Deployment status:"
          kubectl get pods -n ${{ steps.config.outputs.namespace }} -l app=devsu-app
          
          echo ""
          echo "Service info:"
          kubectl get svc -n ${{ steps.config.outputs.namespace }}

      - name: Record promotion artifact
        if: ${{ success() }}
        uses: actions/upload-artifact@v4
        with:
          name: promoted-${{ github.event.inputs.environment }}-${{ steps.config.outputs.image_tag }}
          path: k8s/base/deployment.yml
          retention-days: 30

      - name: Create deployment summary
        if: always()
        run: |
          echo "### Deployment to ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ steps.config.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "**Namespace:** ${{ steps.config.outputs.namespace }}" >> $GITHUB_STEP_SUMMARY
          echo "**Replicas:** ${{ steps.config.outputs.replicas }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
