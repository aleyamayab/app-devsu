name: PR Check - Build, Test & Analyze

on:
  push:
    branches: [develop]

  pull_request:
    branches: [develop]

permissions:
  contents: read
  pull-requests: write
  issues: write

env:
  PYTHON_VERSION: "3.11"
  APP_DIR: app/devsu-demo-devops-python
  DB_ENGINE: "django.db.backends.postgresql"
  DB_NAME: "devsudb"
  DB_HOST: "aksdb.postgres.database.azure.com"
  DB_PORT: "5432"

jobs:
  validate:
    runs-on: ubuntu-latest
    name: Build, Test & Code Analysis

    steps:
      # 1. CHECKOUT - Descargar el código
      - name: "Checkout code"
        uses: actions/checkout@v4

      # 2. PYTHON SETUP - Configurar Python
      - name: "Set up Python ${{ env.PYTHON_VERSION }}"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 3. CACHE - Cachear dependencias para más velocidad
      - name: "Cache pip dependencies"
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles(format('{0}/requirements.txt', env.APP_DIR)) }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # 4. BUILD - Instalar dependencias
      - name: "Build: Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ env.APP_DIR }}/requirements.txt
          pip install flake8 coverage

      # 5. STATIC CODE ANALYSIS - Revisar código con flake8
      - name: "Code Analysis: Lint with flake8"
        id: lint
        working-directory: ${{ env.APP_DIR }}
        continue-on-error: true
        run: |
          echo "Checking for critical syntax errors..."
          flake8 . \
            --count \
            --select=E9,F63,F7,F82 \
            --show-source \
            --statistics \
            --exclude=.venv,venv,__pycache__,migrations,*.pyc,.git,build,dist,*.egg-info
          
          echo ""
          echo "Running extended code quality checks..."
          flake8 . \
            --count \
            --exit-zero \
            --max-complexity=10 \
            --max-line-length=120 \
            --statistics \
            --exclude=.venv,venv,__pycache__,migrations,*.pyc,.git,build,dist,*.egg-info

      # 6. DATABASE MIGRATION - Probar migraciones en Azure Postgres
      - name: "Database: Run migrations on Azure Postgres"
        id: migrate
        working-directory: ${{ env.APP_DIR }}
        env:
          DJANGO_SETTINGS_MODULE: "demo.settings"
          DJANGO_SECRET_KEY: "ci-secret-key-${{ github.run_id }}"
          DB_ENGINE: ${{ env.DB_ENGINE }}
          DB_NAME: "devsudb_test"
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: ${{ env.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DJANGO_DEBUG: "False"
          DJANGO_ALLOWED_HOSTS: "localhost,127.0.0.1"
        run: |
          echo "Connecting to Azure Postgres..."
          python manage.py migrate --noinput
          echo "Migrations successful"

      # 7. UNIT TESTS - Correr tests unitarios contra Azure Postgres
      - name: "Tests: Run unit tests with coverage on Azure Postgres"
        id: tests
        working-directory: ${{ env.APP_DIR }}
        env:
          DJANGO_SETTINGS_MODULE: "demo.settings"
          DJANGO_SECRET_KEY: "ci-secret-key-${{ github.run_id }}"
          DB_ENGINE: ${{ env.DB_ENGINE }}
          DB_NAME: "devsudb_test"
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: ${{ env.DB_PORT }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DJANGO_DEBUG: "False"
          DJANGO_ALLOWED_HOSTS: "localhost,127.0.0.1"
        run: |
          echo "Running unit tests on Azure Postgres..."
          coverage run --source='.' manage.py test api
          
          echo ""
          echo "Coverage report:"
          coverage report -m

      # 8. COVERAGE REPORT - Generar XML para almacenar
      - name: "Coverage: Generate XML report"
        working-directory: ${{ env.APP_DIR }}
        if: always()
        run: |
          coverage xml --omit="*/migrations/*,*/tests.py" || true

      # 9. ARTIFACTS - Guardar reportes
      - name: "Upload coverage report"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-${{ github.run_number }}
          path: ${{ env.APP_DIR }}/coverage.xml
          retention-days: 30

      # 10. PR COMMENT - Comentar en el PR con resumen
      - name: "Comment PR with results"
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coveragePath = '${{ env.APP_DIR }}/coverage.xml';
            
            let comment = '## CI/CD Pipeline Results\n\n';
            comment += '| Step | Status |\n';
            comment += '|------|--------|\n';
            comment += '| Build | \n';
            comment += '| Code Analysis | ' + ('${{ steps.lint.outcome }}' === 'success' ? ' Passed' : ' Warnings') + ' |\n';
            comment += '| Migrations | ' + ('${{ steps.migrate.outcome }}' === 'success' ? ' Passed' : ' Failed') + ' |\n';
            comment += '| Tests | ' + ('${{ steps.tests.outcome }}' === 'success' ? ' Passed' : ' Failed') + ' |\n';
            
            if (fs.existsSync(coveragePath)) {
              comment += '| Coverage | Generated |\n';
            }
            comment += '\n**Coverage report:** Check artifacts for detailed coverage.xml\n';
            
            // Buscar comentario anterior
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const existingComment = comments.find(c => c.body.includes('CI/CD Pipeline Results'));
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      # 11. SUMMARY - Resumen final en GitHub
      - name: "Summary"
        if: always()
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Build & Code Quality" >> $GITHUB_STEP_SUMMARY
          echo "- **Build:** Dependencies installed successfully" >> $GITHUB_STEP_SUMMARY
          echo "- **Code Analysis (Flake8):** $(if [ '${{ steps.lint.outcome }}' == 'success' ]; then echo 'All checks passed'; else echo 'Some warnings detected'; fi)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Database & Tests" >> $GITHUB_STEP_SUMMARY
          echo "- **Migrations:** $(if [ '${{ steps.migrate.outcome }}' == 'success' ]; then echo 'Applied successfully'; else echo 'Failed'; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- **Unit Tests:** $(if [ '${{ steps.tests.outcome }}' == 'success' ]; then echo 'All tests passed'; else echo 'Some tests failed'; fi)" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage:** Report generated and uploaded" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ '${{ steps.tests.outcome }}' == 'success' ] && [ '${{ steps.migrate.outcome }}' == 'success' ]; then
            echo "**This PR is ready to merge!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Please review errors above**" >> $GITHUB_STEP_SUMMARY
          fi
