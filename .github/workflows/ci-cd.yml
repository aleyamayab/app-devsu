name: CI Build & Deploy

on:
  push:
    branches: [develop]

permissions:
  packages: write
  contents: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/aleyamayab/devsu-demo-devops-python
  APP_DIR: app/devsu-demo-devops-python

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build & Deploy DEV (beta)

    steps:
      # ----------------------------
      # 1. Checkout (fetch full history for semantic-release)
      # ----------------------------
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ----------------------------
      # 2. Setup Node.js (semantic-release)
      # ----------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ----------------------------
      # 3. Install semantic-release dependencies
      # ----------------------------
      - name: Install semantic-release dependencies
        run: |
          npm install -g \
            semantic-release \
            conventional-changelog-conventionalcommits \
            @semantic-release/commit-analyzer \
            @semantic-release/release-notes-generator \
            @semantic-release/changelog \
            @semantic-release/git \
            @semantic-release/github

      # ----------------------------
      # 4. Run semantic-release
      # ----------------------------
      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        with:
          branches: |
            [
              "main",
              { "name": "qa", "prerelease": "rc" },
              { "name": "develop", "prerelease": "beta" }
            ]
          extra_plugins: |
            conventional-changelog-conventionalcommits
            @semantic-release/commit-analyzer
            @semantic-release/release-notes-generator
            @semantic-release/changelog
            @semantic-release/git
            @semantic-release/github
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------
      # 5. Stop if no release was generated
      # ----------------------------
      - name: Stop if no new release
        if: steps.semantic.outputs.new_release_published != 'true'
        run: |
          echo "No new release generated. Skipping build."
          exit 0

      # ----------------------------
      # 6. Login to GitHub Container Registry
      # ----------------------------
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ----------------------------
      # 7. Build and push Docker image (beta)
      # ----------------------------
      - name: Build and push DEV image
        run: |
          echo "Building image: $IMAGE_NAME:${{ steps.semantic.outputs.new_release_version }}"
          docker build \
            -t $IMAGE_NAME:${{ steps.semantic.outputs.new_release_version }} \
            ${{ env.APP_DIR }}
          docker push $IMAGE_NAME:${{ steps.semantic.outputs.new_release_version }}

      # ----------------------------
      # 8. Update Kubernetes DEV deployment (GitOps)
      # ----------------------------
      - name: Update DEV deployment manifest
        run: |
          sed -i "s|image: .*|image: $IMAGE_NAME:${{ steps.semantic.outputs.new_release_version }}|" \
            k8s/dev/deployment.yml

      # ----------------------------
      # 9. Commit and push manifest change
      # ----------------------------
      - name: Commit DEV deployment update
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add k8s/dev/deployment.yml
          git commit -m "chore(dev): deploy ${{ steps.semantic.outputs.new_release_version }} [skip ci]"
          git push origin develop
